fluid=fluid||{};(function($,fluid){var defaultSelectors={upload:".fluid-uploader-upload",resume:".fluid-uploader-resume",pause:".fluid-uploader-pause",done:".fluid-uploader-done",cancel:".fluid-uploader-cancel",browse:".fluid-uploader-browse",fluidUploader:".fluid-uploader-queue-wrapper",fileQueue:".fluid-uploader-queue",queueRow:"tr",scrollingElement:".fluid-scroller",emptyRow:".fluid-uploader-row-placeholder",txtTotalFiles:".fluid-uploader-totalFiles",txtTotalBytes:".fluid-uploader-totalBytes",txtTotalFilesUploaded:".fluid-uploader-num-uploaded",txtTotalBytesUploaded:".fluid-uploader-bytes-uploaded",osModifierKey:".fluid-uploader-modifierKey",txtFileStatus:".removeFile",uploaderFooter:".fluid-scroller-table-foot",qRowTemplate:"#queue-row-tmplt",qRowFileName:".fileName",qRowFileSize:".fileSize",qRowRemove:".removeFile",fileProgressor:".file-progress",fileProgressText:".file-progress-text",totalProgressor:".total-progress",totalProgressText:".fluid-scroller-table-foot .footer-total",debug:false};var uploadDefaults={uploadUrl:"",flashUrl:"",fileSizeLimit:"20480",fileTypes:"*.*",fileTypesText:"image files",fileUploadLimit:0,fileQueueLimit:0,elmUploaderControl:"",whenDone:"",whenCancel:"",whenFileUploaded:function(fileName,serverResponse){},postParams:{},httpUploadElm:"",continueAfterUpload:true,continueDelay:2000,queueListMaxHeight:190,fragmentSelectors:defaultSelectors,browseOnInit:false,dialogDisplay:false,addFilesBtn:".fluid-add-files-btn",debug:false};var dialog_settings={title:"Upload Files",width:482,height:"",draggable:true,modal:false,resizable:false,autoOpen:false};var strings={macControlKey:"Command",browseText:"Browse files",addMoreText:"Add more",fileUploaded:"File Uploaded",pausedLabel:"Paused at: %curFileN of %totalFilesN files (%currBytes of %totalBytes)",totalLabel:"Uploading: %curFileN of %totalFilesN files (%currBytes of %totalBytes)",completedLabel:"Uploaded: %curFileN files (%totalCurrBytes)"};var addFileToQueue=function(uploaderContainer,file,fragmentSelectors,swfObj,status,maxHeight){var newQueueRow=$(fragmentSelectors.qRowTemplate).clone();$(newQueueRow).children(fragmentSelectors.qRowFileName).text(file.name);$(newQueueRow).children(fragmentSelectors.qRowFileSize).text(fluid.utils.formatFileSize(file.size));newQueueRow.attr("id",file.id).css("display","none").addClass("ready row").hover(function(){if($(this).hasClass("ready")&&!$(this).hasClass("uploading")){$(this).addClass("hover")}},function(){if($(this).hasClass("ready")&&!$(this).hasClass("uploading")){$(this).removeClass("hover")}});var fileQueue=$(fragmentSelectors.fileQueue,uploaderContainer);fileQueue.append(newQueueRow);var removeThisRow=function(){if(uploadState(uploaderContainer)!=="uploading"){removeRow(uploaderContainer,fragmentSelectors,newQueueRow,swfObj,status,maxHeight)}};$("#"+file.id,uploaderContainer).find(fragmentSelectors.qRowRemove).click(removeThisRow);newQueueRow.activatable(null,{additionalBindings:[{key:$.a11y.keys.DELETE,activateHandler:function(){$("#"+file.id,uploaderContainer).find(fragmentSelectors.qRowRemove).click()}}]});updateSelectable(fileQueue);$("#"+file.id,uploaderContainer).fadeIn("slow")};var removeRow=function(uploaderContainer,fragmentSelectors,row,swfObj,status,maxHeight){row.fadeOut("fast",function(){var fileId=row.attr("id");var file=swfObj.getFile(fileId);queuedBytes(status,-file.size);swfObj.cancelUpload(fileId);row.remove();updateQueueHeight($(fragmentSelectors.scrollingElement,uploaderContainer),maxHeight);updateNumFiles(uploaderContainer,fragmentSelectors.txtTotalFiles,fragmentSelectors.fileQueue,fragmentSelectors.emptyRow);updateTotalBytes(uploaderContainer,fragmentSelectors.txtTotalBytes,status);updateStateByState(uploaderContainer,fragmentSelectors.fileQueue);updateBrowseBtnText(uploaderContainer,fragmentSelectors.fileQueue,fragmentSelectors.browse,status);var fileQueue=$(fragmentSelectors.fileQueue,uploaderContainer);updateSelectable(fileQueue)});return row};var updateSelectable=function(container){container.getSelectableContext().refresh()};var updateQueueHeight=function(scrollingElm,maxHeight){var overMaxHeight=(scrollingElm.children().eq(0).height()>maxHeight);var setHeight=(overMaxHeight)?maxHeight:"";scrollingElm.height(setHeight);return overMaxHeight};var scrollBottom=function(scrollingElm){scrollingElm=$(scrollingElm)[0];scrollingElm.scrollTop=scrollingElm.scrollHeight};var scrollTo=function(scrollingElm,row){if($(row).prev().length){var nextRow=$(row).next();row=(nextRow.length===0)?row:nextRow}var rowPosTop=$(row)[0].offsetTop;var rowHeight=$(row).height();var containerScrollTop=$(scrollingElm)[0].scrollTop;var containerHeight=$(scrollingElm).height();if(rowPosTop<containerScrollTop){$(scrollingElm)[0].scrollTop=rowPosTop}if((rowPosTop+rowHeight)>(containerScrollTop+containerHeight)){$(scrollingElm)[0].scrollTop=(rowPosTop-containerHeight+rowHeight)}};var updateNumFiles=function(uploaderContainer,totalFilesSelector,fileQueueSelector){$(totalFilesSelector,uploaderContainer).text(numberOfRows(uploaderContainer,fileQueueSelector))};var updateTotalBytes=function(uploaderContainer,totalBytesSelector,status){$(totalBytesSelector,uploaderContainer).text(fluid.utils.formatFileSize(queuedBytes(status)))};var updateStateByState=function(uploaderContainer,fileQueueSelector){var totalRows=numberOfRows(uploaderContainer,fileQueueSelector);var rowsUploaded=numFilesUploaded(uploaderContainer,fileQueueSelector);var rowsReady=numFilesToUpload(uploaderContainer,fileQueueSelector);fluid.utils.debug("totalRows = "+totalRows+"\nrowsUploaded = "+rowsUploaded+"\nrowsReady = "+rowsReady);if(rowsUploaded>0){if(rowsReady===0){updateState(uploaderContainer,"empty")}else{updateState(uploaderContainer,"reloaded")}}else{if(totalRows===0){updateState(uploaderContainer,"start")}else{updateState(uploaderContainer,"loaded")}}};var updateState=function(uploaderContainer,stateClass){$(uploaderContainer).children("div:first").attr("className",stateClass)};var uploadState=function(uploaderContainer){return $(uploaderContainer).children("div:first").attr("className")};var updateBrowseBtnText=function(uploaderContainer,fileQueueSelector,browseButtonSelector,status){if(numberOfRows(uploaderContainer,fileQueueSelector)>0){$(browseButtonSelector,uploaderContainer).text(strings.addMoreText)}else{$(browseButtonSelector,uploaderContainer).text(strings.browseText)}};var markRowComplete=function(row,fileStatusSelector,removeBtnSelector){rowChangeState(row,removeBtnSelector,fileStatusSelector,"uploaded",strings.fileUploaded)};var markRowError=function(row,fileStatusSelector,removeBtnSelector,scrollingElm,maxHeight,humanError){rowChangeState(row,removeBtnSelector,fileStatusSelector,"error","File Upload Error");updateQueueHeight(scrollingElm,maxHeight);if(humanError!==""){displayHumanReableError(row,humanError)}};var rowChangeState=function(row,removeBtnSelector,fileStatusSelector,stateClass,stateMessage){row.removeClass("ready").addClass(stateClass);$(row).find(removeBtnSelector).unbind("click");$(row).find(removeBtnSelector).tabindex(-1);$(row).find(fileStatusSelector).attr("title",stateMessage)};var displayHumanReableError=function(row,humanError){var newErrorRow=$("#queue-error-tmplt").clone();$(newErrorRow).find(".queue-error").html(humanError);$(newErrorRow).removeAttr("id").insertAfter(row)};var variableAction=function(action){if(action!==undefined){if(typeof action==="function"){action()}else{location.href=action}}};var createFileQueuedHandler=function(uploaderContainer,fragmentSelectors,maxHeight,status,dialogObj){return function(file){var swfObj=this;try{fluid.utils.debug(file.name+" file.size = "+file.size);if(dialogObj){$(dialogObj).dialog("open")}addFileToQueue(uploaderContainer,file,fragmentSelectors,swfObj,status,maxHeight);updateStateByState(uploaderContainer,fragmentSelectors.fileQueue);var scrollingElm=$(fragmentSelectors.scrollingElement,uploaderContainer);if(updateQueueHeight(scrollingElm,maxHeight)){scrollBottom(scrollingElm)}queuedBytes(status,file.size);updateNumFiles(uploaderContainer,fragmentSelectors.txtTotalFiles,fragmentSelectors.fileQueue,fragmentSelectors.emptyRow);updateTotalBytes(uploaderContainer,fragmentSelectors.txtTotalBytes,status)}catch(ex){fluid.utils.debug(ex)}}};var createSWFReadyHandler=function(browseOnInit,allowMultipleFiles,useDialog){return function(){if(browseOnInit&&!useDialog){browseForFiles(this,allowMultipleFiles)}}};function browseForFiles(swfObj,allowMultipleFiles){if(allowMultipleFiles){swfObj.selectFiles()}else{swfObj.selectFile()}}var createFileDialogStartHandler=function(uploaderContainer){return function(){try{$(uploaderContainer).children("div:first").addClass("browsing")}catch(ex){fluid.utils.debug(ex)}}};var createFileDialogCompleteHandler=function(uploaderContainer,fragmentSelectors,status){return function(numSelected,numQueued){try{updateBrowseBtnText(uploaderContainer,fragmentSelectors.fileQueue,fragmentSelectors.browse,status);$(uploaderContainer).children("div:first").removeClass("browsing");if(numberOfRows(uploaderContainer,fragmentSelectors.fileQueue)){$(fragmentSelectors.upload,uploaderContainer).focus()}debugStatus(status)}catch(ex){fluid.utils.debug(ex)}}};function fileQueueError(file,error_code,message){try{var error_name="";switch(error_code){case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:error_name="QUEUE LIMIT EXCEEDED";break;case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:error_name="FILE EXCEEDS SIZE LIMIT";break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:error_name="ZERO BYTE FILE";break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:error_name="INVALID FILE TYPE";break;default:error_name="UNKNOWN";break}var error_string=error_name+":File ID: "+(typeof (file)==="object"&&file!==null?file.id:"na")+":"+message;fluid.utils.debug("error_string = "+error_string)}catch(ex){fluid.utils.debug(ex)}}var createUploadStartHandler=function(uploaderContainer,fragmentSelectors,progressBar,status){return function(file){uploadStart(file,uploaderContainer,fragmentSelectors,progressBar,status)}};var uploadStart=function(file,uploaderContainer,fragmentSelectors,progressBar,status){fluid.utils.debug("Upload Start Handler");updateState(uploaderContainer,"uploading");status.currError="";$("#"+file.id,uploaderContainer).addClass("uploading");progressBar.init("#"+file.id);scrollTo($(fragmentSelectors.scrollingElement,uploaderContainer),$("#"+file.id,uploaderContainer));uploadProgress(progressBar,uploaderContainer,file,0,file.size,fragmentSelectors,status);fluid.utils.debug("Starting Upload: "+(file.index+1)+" ("+file.id+") ["+file.size+"] "+file.name);$(fragmentSelectors.pause,uploaderContainer).focus()};var createUploadProgressHandler=function(progressBar,uploaderContainer,fragmentSelectors,status){return function(file,bytes,totalBytes){uploadProgress(progressBar,uploaderContainer,file,bytes,totalBytes,fragmentSelectors,status)}};var createUploadErrorHandler=function(uploaderContainer,progressBar,fragmentSelectors,maxHeight,status,options){return function(file,error_code,message){uploadError(file,error_code,message,uploaderContainer,progressBar,fragmentSelectors,maxHeight,status,options)}};var uploadError=function(file,error_code,message,uploaderContainer,progressBar,fragmentSelectors,maxHeight,status,options){fluid.utils.debug("Upload Error Handler");status.currError="";status.continueOnError=false;var humanErrorMsg="";var markError=true;try{switch(error_code){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:status.currError="Error Code: HTTP Error, File name: "+file.name+", Message: "+message;humanErrorMsg="An error occurred on the server during upload. It could be that the file already exists on the server."+formatErrorCode(message);status.continueOnError=true;break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:status.currError="Error Code: Upload Failed, File name: "+file.name+", File size: "+file.size+", Message: "+message;break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:status.currError="Error Code: IO Error, File name: "+file.name+", Message: "+message;humanErrorMsg="An error occurred attempting to read the file from disk. The file was not uploaded."+formatErrorCode(message);status.continueOnError=true;break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:status.currError="Error Code: Security Error, File name: "+file.name+", Message: "+message;break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:status.currError="Error Code: Upload Limit Exceeded, File name: "+file.name+", File size: "+file.size+", Message: "+message;break;case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:status.currError="Error Code: File Validation Failed, File name: "+file.name+", File size: "+file.size+", Message: "+message;break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:status.currError="File cancelled by user";status.continueOnError=true;markError=false;break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:status.currError="Upload Stopped by user input";var pauseStrings={curFileN:numFilesUploaded(uploaderContainer,fragmentSelectors.fileQueue),totalFilesN:numberOfRows(uploaderContainer,fragmentSelectors.fileQueue),currBytes:fluid.utils.formatFileSize(status.currBytes),totalBytes:fluid.utils.formatFileSize(status.totalBytes)};var pausedString=fluid.utils.stringTemplate(strings.pausedLabel,pauseStrings);$(fragmentSelectors.totalProgressText,uploaderContainer).html(pausedString);updateState(uploaderContainer,"paused");markError=false;break;default:status.currError="Error Code: "+error_code+", File name: "+file.name+", File size: "+file.size+", Message: "+message;break}if(markError){markRowError($("tr#"+file.id,uploaderContainer),fragmentSelectors.txtFileStatus,fragmentSelectors.qRowRemove,$(fragmentSelectors.scrollingElement,uploaderContainer),maxHeight,humanErrorMsg)}fluid.utils.debug(status.currError+"\n"+humanErrorMsg);options.continueAfterUpload=false}catch(ex){fluid.utils.debug(ex)}};var formatErrorCode=function(str){return" (Error code: "+str+")"};var createUploadSuccessHandler=function(uploaderContainer,progressBar,fragmentSelectors,whenFileUploaded,status){return function(file,server_data){uploadSuccess(uploaderContainer,file,progressBar,fragmentSelectors,status,whenFileUploaded,server_data)}};var uploadSuccess=function(uploaderContainer,file,progressBar,fragmentSelectors,status,whenFileUploaded,server_data){fluid.utils.debug("Upload Success Handler");uploadProgress(progressBar,uploaderContainer,file,file.size,file.size,fragmentSelectors,status);markRowComplete($("tr#"+file.id,uploaderContainer),fragmentSelectors.txtFileStatus,fragmentSelectors.qRowRemove);try{whenFileUploaded(file.name,server_data)}catch(ex){fluid.utils.debug(ex)}};var createUploadCompleteHandler=function(uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj){return function(file){uploadComplete(this,file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj)}};var uploadComplete=function(swfObj,file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj){fluid.utils.debug("Upload Complete Handler");$("#"+file.id,uploaderContainer).removeClass("uploading");var totalCount=numberOfRows(uploaderContainer,fragmentSelectors.fileQueue);var currStats=swfObj.getStats();fluid.utils.debug("currStats.files_queued = "+currStats.files_queued+"\ncurrStats.successful_uploads = "+currStats.successful_uploads+"\ncurrStats.upload_errors = "+currStats.upload_errors);if(currStats.files_queued===0){return fileQueueComplete(uploaderContainer,swfObj,options,progressBar,fragmentSelectors,dialogObj,status)}else{if(!status.currError||status.continueOnError){uploadedBytes(status,file.size);return swfObj.startUpload()}else{return hideProgress(progressBar,true,$(fragmentSelectors.resume,uploaderContainer))}}};var fileQueueComplete=function(uploaderContainer,swfObj,options,progressBar,fragmentSelectors,dialogObj,status){fluid.utils.debug("File Queue Complete Handler");updateState(uploaderContainer,"done");var stats=swfObj.getStats();var newStrings={curFileN:stats.successful_uploads,totalCurrBytes:fluid.utils.formatFileSize(status.totalBytes)};$(fragmentSelectors.totalProgressText,uploaderContainer).html(fluid.utils.stringTemplate(strings.completedLabel,newStrings));hideProgress(progressBar,true,$(fragmentSelectors.done,uploaderContainer));options.continueDelay=(!options.continueDelay)?0:options.continueDelay;if(options.continueAfterUpload){setTimeout(function(){variableAction(options.whenDone)},options.continueDelay)}};var queuedBytes=function(status,delta){if(typeof delta==="number"){status.totalBytes+=delta}return status.totalBytes};var uploadedBytes=function(status,delta){if(typeof delta==="number"){status.currBytes+=delta}return status.currBytes};function readyBytes(status){return(status.totalBytes-status.currBytes)}function numberOfRows(uploaderContainer,fileQueueSelector){return $(fileQueueSelector,uploaderContainer).find(".row").length}function numFilesToUpload(uploaderContainer,fileQueueSelector){return $(fileQueueSelector,uploaderContainer).find(".ready").length}function numFilesUploaded(uploaderContainer,fileQueueSelector){return $(fileQueueSelector,uploaderContainer).find(".uploaded").length}var uploadProgress=function(progressBar,uploaderContainer,file,fileBytes,totalFileBytes,fragmentSelectors,status){fluid.utils.debug("Upload Progress Handler");fluid.utils.debug("Upload Status : \n"+file.name+" : "+fileBytes+" of "+totalFileBytes+" bytes : \ntotal : "+(status.currBytes+fileBytes)+" of "+queuedBytes(status)+" bytes");var filePercent=fluid.utils.derivePercent(fileBytes,totalFileBytes);progressBar.updateProgress("file",filePercent,filePercent+"%");var totalQueueBytes=queuedBytes(status);var currQueueBytes=status.currBytes+fileBytes;var totalPercent=fluid.utils.derivePercent(currQueueBytes,totalQueueBytes);var fileIndex=file.index+1;var numFilesInQueue=numberOfRows(uploaderContainer,fragmentSelectors.fileQueue);var totalHTML=totalStr(fileIndex,numFilesInQueue,currQueueBytes,totalQueueBytes);progressBar.updateProgress("total",totalPercent,totalHTML)};function totalStr(fileIndex,numRows,bytes,totalBytes){var newStrings={curFileN:fileIndex,totalFilesN:numRows,currBytes:fluid.utils.formatFileSize(bytes),totalBytes:fluid.utils.formatFileSize(totalBytes)};return fluid.utils.stringTemplate(strings.totalLabel,newStrings)}var hideProgress=function(progressBar,dontPause,focusAfterHide){progressBar.hide(dontPause);focusAfterHide.focus()};var initDialog=function(uploaderContainer,addBtnSelector,browseOnInit,fileBrowseSelector){dialogObj=uploaderContainer.dialog(dialog_settings).css("display","block");var clickBehaviour=function(){if(browseOnInit){$(fileBrowseSelector,uploaderContainer).click()}else{setTimeout(function(){$(dialogObj).dialog("open");$(fileBrowseSelector).focus()},0)}};var addBtn=$(addBtnSelector);addBtn.click(clickBehaviour);addBtn.activatable(clickBehaviour);return dialogObj};var closeDialog=function(dialogObj){$(dialogObj).dialog("close")};function debugStatus(status){fluid.utils.debug("\n status.totalBytes = "+queuedBytes(status)+"\n status.currCount = "+status.currCount+"\n status.currBytes = "+status.currBytes+"\n status.currError = "+status.currError+"\n status.continueOnError = "+status.continueOnError)}var demoUpload=function(uploaderContainer,swfObj,progressBar,options,fragmentSelectors,status,dialogObj){fluid.utils.debug("demoUpload Handler");var demoState={};demoState.byteChunk=200000;demoState.row=$(fragmentSelectors.fileQueue+' tbody tr:not(".fluid-uploader-placeholder"):not(".uploaded):not(".error)',uploaderContainer).eq(0);demoState.fileId=jQuery(demoState.row).attr("id");demoState.file=swfObj.getFile(demoState.fileId);fluid.utils.debug("num of ready files = "+numFilesToUpload(uploaderContainer,fragmentSelectors.fileQueue));if(status.stop===true){demoPause(swfObj,demoState.file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj,0)}else{if(numFilesToUpload(uploaderContainer,fragmentSelectors.fileQueue)){status.stop=false;demoState.bytes=0;demoState.totalBytes=demoState.file.size;demoState.numChunks=Math.ceil(demoState.totalBytes/demoState.byteChunk);fluid.utils.debug("DEMO :: "+demoState.fileId+" :: totalBytes = "+demoState.totalBytes+" numChunks = "+demoState.numChunks);uploadStart(demoState.file,uploaderContainer,fragmentSelectors,progressBar,status);demoProgress(demoState,swfObj,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj)}else{fileQueueComplete(uploaderContainer,swfObj,options,progressBar,fragmentSelectors,dialogObj,status)}}function demoProgress(demoState,swfObj,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj){var timer;var delay=Math.floor(Math.random()*1000+100);if(status.stop===true){demoPause(swfObj,demoState.file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj,delay)}else{status.stop=false;var tmpBytes=(demoState.bytes+demoState.byteChunk);if(tmpBytes<demoState.totalBytes){fluid.utils.debug("tmpBytes = "+tmpBytes+" totalBytes = "+demoState.totalBytes);uploadProgress(progressBar,uploaderContainer,demoState.file,tmpBytes,demoState.totalBytes,fragmentSelectors,status);demoState.bytes=tmpBytes;timer=setTimeout(function(){demoProgress(demoState,swfObj,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj)},delay)}else{uploadSuccess(uploaderContainer,demoState.file,progressBar,fragmentSelectors,status);timer=setTimeout(function(){uploadComplete(swfObj,demoState.file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj)},delay);swfObj.cancelUpload(demoState.fileId)}}status.stop=false}function demoPause(swfObj,file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj,delay){uploadError(file,-290,"",uploaderContainer,progressBar,fragmentSelectors,options.queueListMaxHeight,status,options);uploadComplete(swfObj,file,uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj);status.stop=false}};function initSWFUpload(uploaderContainer,uploadURL,flashURL,progressBar,status,fragmentSelectors,options,allowMultipleFiles,dialogObj){if(typeof (SWFUpload)==="undefined"){return null}var swf_settings={upload_url:uploadURL,flash_url:flashURL,post_params:options.postParams,file_size_limit:options.fileSizeLimit,file_types:options.fileTypes,file_types_description:options.fileTypesDescription,file_upload_limit:options.fileUploadLimit,file_queue_limit:options.fileQueueLimit,swfupload_loaded_handler:createSWFReadyHandler(options.browseOnInit,allowMultipleFiles,options.dialogDisplay),file_dialog_start_handler:createFileDialogStartHandler(uploaderContainer),file_queued_handler:createFileQueuedHandler(uploaderContainer,fragmentSelectors,options.queueListMaxHeight,status,dialogObj),file_queue_error_handler:fileQueueError,file_dialog_complete_handler:createFileDialogCompleteHandler(uploaderContainer,fragmentSelectors,status),upload_start_handler:createUploadStartHandler(uploaderContainer,fragmentSelectors,progressBar,status),upload_progress_handler:createUploadProgressHandler(progressBar,uploaderContainer,fragmentSelectors,status),upload_error_handler:createUploadErrorHandler(uploaderContainer,progressBar,fragmentSelectors,options.queueListMaxHeight,status,options),upload_success_handler:createUploadSuccessHandler(uploaderContainer,progressBar,fragmentSelectors,options.whenFileUploaded,status),upload_complete_handler:createUploadCompleteHandler(uploaderContainer,progressBar,fragmentSelectors,status,options,dialogObj),debug:options.debug};return new SWFUpload(swf_settings)}var whichOS=function(){if(navigator.appVersion.indexOf("Win")!==-1){return"Windows"}if(navigator.appVersion.indexOf("Mac")!==-1){return"MacOS"}if(navigator.appVersion.indexOf("X11")!==-1){return"UNIX"}if(navigator.appVersion.indexOf("Linux")!==-1){return"Linux"}else{return"unknown"}};var setKeyboardModifierString=function(uploaderContainer,modifierKeySelector){if(whichOS()==="MacOS"){$(modifierKeySelector,uploaderContainer).text(strings.macControlKey)}};var bindEvents=function(uploader,uploaderContainer,swfObj,allowMultipleFiles,whenDone,whenCancel){var activateBrowse=function(){if(uploadState(uploaderContainer)!=="uploading"){return(allowMultipleFiles)?swfObj.selectFiles():swfObj.selectFile()}};var browseButton=$(uploader.fragmentSelectors.browse,uploaderContainer);browseButton.click(activateBrowse);browseButton.tabbable();fluid.utils.debug();var fileQueue=$(uploader.fragmentSelectors.fileQueue,uploaderContainer);fileQueue.selectable({selectableSelector:uploader.fragmentSelectors.queueRow});$(uploader.fragmentSelectors.upload,uploaderContainer).click(function(){if($(uploader.fragmentSelectors.upload,uploaderContainer).css("cursor")==="pointer"){uploader.actions.beginUpload()}});$(uploader.fragmentSelectors.resume,uploaderContainer).click(function(){if($(uploader.fragmentSelectors.resume,uploaderContainer).css("cursor")==="pointer"){uploader.actions.beginUpload()}});$(uploader.fragmentSelectors.pause,uploaderContainer).click(function(){swfObj.stopUpload()});$(uploader.fragmentSelectors.done,uploaderContainer).click(function(){if(uploadState(uploaderContainer)!=="uploading"){variableAction(whenDone)}});$(uploader.fragmentSelectors.cancel,uploaderContainer).click(function(){variableAction(whenCancel)})};var enableDemoMode=function(uploaderContainer,swfObj,progressBar,options,fragmentSelectors,status,dialogObj){swfObj.startUpload=function(){demoUpload(uploaderContainer,swfObj,progressBar,options,fragmentSelectors,status,dialogObj)};swfObj.stopUpload=function(){status.stop=true}};fluid.Uploader=function(uploaderContainerId,uploadURL,flashURL,settings){this.uploaderContainer=fluid.utils.jById(uploaderContainerId);this.options=$.extend({},uploadDefaults,settings);this.fragmentSelectors=this.options.fragmentSelectors;this.status={totalBytes:0,currBytes:0,currError:"",continueOnError:false,stop:false};var progressOptions={progress:this.uploaderContainer,fileProgressor:this.fragmentSelectors.fileProgressor,fileText:this.fragmentSelectors.fileProgressText,totalProgressor:this.fragmentSelectors.totalProgressor,totalText:this.fragmentSelectors.totalProgressText,totalProgressContainer:this.fragmentSelectors.uploaderFooter};var progressBar=new fluid.Progress(progressOptions);var allowMultipleFiles=(this.options.fileQueueLimit!==1);if(this.options.dialogDisplay){var dialogObj=initDialog(this.uploaderContainer,this.options.addFilesBtn,this.options.browseOnInit,this.fragmentSelectors.browse)}var swfObj=initSWFUpload(this.uploaderContainer,uploadURL,flashURL,progressBar,this.status,this.fragmentSelectors,this.options,allowMultipleFiles,dialogObj);$("#"+swfObj.movieName).tabindex("-1");this.actions=new fluid.SWFWrapper(swfObj);setKeyboardModifierString(this.uploaderContainer,this.fragmentSelectors.osModifierKey);bindEvents(this,this.uploaderContainer,swfObj,allowMultipleFiles,this.options.whenDone,this.options.whenCancel);$(this.fragmentSelectors.fileQueue).tabbable();if(uploadURL===""){enableDemoMode(this.uploaderContainer,swfObj,progressBar,this.options,this.fragmentSelectors,this.status,dialogObj)}};fluid.Uploader.prototype._test=function(){var str="";for(key in options){if(options.hasOwnProperty(key)){str+=key+" = "+options[key]+"\n"}}for(key in this.fragmentSelectors){if(this.fragmentSelectors.hasOwnProperty(key)){str+=key+" = "+this.fragmentSelectors[key]+"\n"}}fluid.utils.debug(str)};fluid.SWFWrapper=function(swfObject){this.swfObj=swfObject};fluid.SWFWrapper.prototype.beginUpload=function(){this.swfObj.startUpload()}})(jQuery,fluid);(function($){function animateToWidth(elm,width){elm.animate({width:width,queue:false},200)}var hideNow=function(which){$(which).fadeOut("slow")};var initARIA=function(container){container.ariaRole("progressbar");container.ariaState("valuemin","0");container.ariaState("valuemax","100");container.ariaState("live","assertive");container.ariaState("busy","false");container.ariaState("valuenow","0");container.ariaState("valuetext","")};var updateARIA=function(container,percent){var busy=percent<100&&percent>0;container.ariaState("busy",busy);container.ariaState("valuenow",percent);if(busy){container.ariaState("valuetext","Upload is "+percent+" percent complete")}else{if(percent===100){container.ariaState("valuetext","Upload is complete. To upload more files, click the Add More button.")}}};fluid.Progress=function(options){this.minWidth=5;this.progressContainer=options.progress;this.fileProgressElm=$(options.fileProgressor,this.progressContainer);this.fileTextElm=$(options.fileText,this.progressContainer);this.totalProgressElm=$(options.totalProgressor,this.progressContainer);this.totalTextElm=$(options.totalText,this.progressContainer);this.totalProgressContainer=$(options.totalProgressContainer,this.progressContainer);this.totalProgressElm.width(this.minWidth);this.fileProgressElm.hide();this.totalProgressElm.hide();initARIA(this.totalProgressContainer)};fluid.Progress.prototype.init=function(fileRowSelector){this.currRowElm=$(fileRowSelector,this.progressContainer);this.fileProgressElm.width(this.minWidth);this.fileProgressElm.css("top",(this.currRowElm.position().top)).height(this.currRowElm.height()).width(this.minWidth);if($.browser.msie&&$.browser.version<7){this.totalProgressElm.height(this.totalProgressElm.siblings().height())}this.totalProgressElm.show();this.fileProgressElm.show()};fluid.Progress.prototype.updateProgress=function(which,percent,text,dontAnimate){if(which==="file"){setProgress(percent,text,this.fileProgressElm,this.currRowElm,this.fileTextElm,dontAnimate)}else{setProgress(percent,text,this.totalProgressElm,this.totalProgressContainer,this.totalTextElm,dontAnimate);updateARIA(this.totalProgressContainer,percent)}};var setProgress=function(percent,text,progressElm,containerElm,textElm,dontAnimate){var containerWidth=containerElm.width();var currWidth=progressElm.width();var newWidth=((percent*containerWidth)/100);progressElm.queue("fx",[]);textElm.html(text);if(percent===0){progressElm.width(this.minWidth)}else{if(newWidth<currWidth||dontAnimate){progressElm.width(newWidth)}else{animateToWidth(progressElm,newWidth)}}};fluid.Progress.prototype.hide=function(dontPause){var delay=1600;if(dontPause){hideNow(this.fileProgressElm);hideNow(this.totalProgressElm)}else{var timeOut=setTimeout(function(){hideNow(this.fileProgressElm);hideNow(this.totalProgressElm)},delay)}};fluid.Progress.prototype.show=function(){this.progressContainer.fadeIn("slow")};fluid.utils=fluid.utils||{};fluid.utils.formatFileSize=function(bytes){if(typeof bytes==="number"){if(bytes===0){return"0.0 KB"}else{if(bytes>0){if(bytes<1048576){return(Math.ceil(bytes/1024*10)/10).toFixed(1)+" KB"}else{return(Math.ceil(bytes/1048576*10)/10).toFixed(1)+" MB"}}}}return""}})(jQuery,fluid);