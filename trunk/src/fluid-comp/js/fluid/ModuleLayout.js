fluid=fluid||{};fluid.moduleLayout=fluid.moduleLayout||{};(function(jQuery,fluid){var internals={layoutWalker:function(fn,layout){for(var col=0;col<layout.columns.length;col++){var idsInCol=layout.columns[col].children;for(var i=0;i<idsInCol.length;i++){var fnReturn=fn(idsInCol,i,col);if(fnReturn){return fnReturn}}}},findColumnAndItemIndices:function(itemId,layout){var findIndices=function(idsInCol,index,col){if(idsInCol[index]===itemId){return{columnIndex:col,itemIndex:index}}};var indices=internals.layoutWalker(findIndices,layout);return indices||{columnIndex:-1,itemIndex:-1}},findColIndex:function(colId,layout){for(var col=0;col<layout.columns.length;col++){if(colId===layout.columns[col].id){return col}}return -1},findItemIndex:function(itemId,layout){return internals.findColumnAndItemIndices(itemId,layout).itemIndex},numColumns:function(layout){return layout.columns.length},numModules:function(layout){var numModules=0;for(var col=0;col<layout.columns.length;col++){numModules+=layout.columns[col].children.length}return numModules},isColumnIndex:function(index,layout){return(index<layout.columns.length)&&(index>=0)},findItemAndTargetIndices:function(itemId,targetId,position,layout){var columns=layout.columns;var foundIndices={itemIndex:-1,targetIndex:-1};if(!itemId||!targetId){return foundIndices}var itemIndexCounter=0;var targetIndexCounter=position;for(var i=0;i<columns.length;i++){var idsInCol=columns[i].children;for(var j=0;j<idsInCol.length;j++){var currId=idsInCol[j];if(currId===itemId){foundIndices.itemIndex=itemIndexCounter}if(currId===targetId){foundIndices.targetIndex=targetIndexCounter}if(foundIndices.itemIndex>=0&&foundIndices.targetIndex>=0){return foundIndices}itemIndexCounter++;targetIndexCounter++}targetIndexCounter++}return foundIndices},getItemAt:function(columnIndex,itemIndex,layout){var itemId=null;var cols=layout.columns;if(columnIndex>=0&&columnIndex<cols.length){var idsInCol=cols[columnIndex].children;if(itemIndex>=0&&itemIndex<idsInCol.length){itemId=idsInCol[itemIndex]}}return itemId},canItemMove:function(itemIndex,perms){var itemPerms=perms[itemIndex];for(var i=0;i<itemPerms.length;i++){if(itemPerms[i]===1){return true}}return false},isDropTarget:function(beforeTargetIndex,perms){for(var i=0;i<perms.length;i++){if(perms[i][beforeTargetIndex]===1||perms[i][beforeTargetIndex+1]===1){return true}}return false},targetAndPos:function(itemId,position,layout,perms){var inc=(position===fluid.position.BEFORE)?-1:1;var startCoords=internals.findColumnAndItemIndices(itemId,layout);var defaultTarg={id:itemId,position:fluid.position.USE_LAST_KNOWN};if(startCoords.columnIndex<0){return defaultTarg}var idsInCol=layout.columns[startCoords.columnIndex].children;var firstTarg;for(var i=startCoords.itemIndex+inc;i>-1&&i<idsInCol.length;i=i+inc){var targetId=idsInCol[i];if(fluid.moduleLayout.canMove(itemId,targetId,position,layout,perms)){return{id:targetId,position:position}}else{if(!firstTarg){firstTarg={id:targetId,position:fluid.position.DISALLOWED}}}}return firstTarg||defaultTarg},findPortletsInColumn:function(portlets,column){var portletsForColumn=[];portlets.each(function(idx,portlet){if(jQuery("[id="+portlet.id+"]",column)[0]){portletsForColumn.push(portlet)}});return portletsForColumn},columnStructure:function(column,portletsInColumn){var structure={};structure.id=column.id;structure.children=[];jQuery(portletsInColumn).each(function(idx,portlet){structure.children.push(portlet.id)});return structure}};fluid.moduleLayout.internals=internals;fluid.moduleLayout.isColumn=function(id,layout){var colIndex=internals.findColIndex(id,layout);return(colIndex>-1)};fluid.moduleLayout.canMove=function(itemId,targetItemId,position,layout,perms){if((position===fluid.position.USE_LAST_KNOWN)||(position===fluid.position.DISALLOWED)){return false}if(position===fluid.position.INSIDE){return true}var indices=internals.findItemAndTargetIndices(itemId,targetItemId,position,layout);return(!!perms[indices.itemIndex][indices.targetIndex])};fluid.moduleLayout.firstItemInAdjacentColumn=function(itemId,direction,layout){var findItemInAdjacentCol=function(idsInCol,index,col){var id=idsInCol[index];if(id===itemId){var adjacentCol=col+direction;var adjacentItem=internals.getItemAt(adjacentCol,0,layout);while(!adjacentItem){adjacentCol=adjacentCol+direction;if(internals.isColumnIndex(adjacentCol,layout)){adjacentItem=internals.getItemAt(adjacentCol,0,layout)}else{adjacentItem=itemId}}return adjacentItem}};return internals.layoutWalker(findItemInAdjacentCol,layout)||itemId};fluid.moduleLayout.itemAboveBelow=function(itemId,direction,layout){var findItemAboveBelow=function(idsInCol,index){if(idsInCol[index]===itemId){var siblingIndex=index+direction;if((siblingIndex<0)||(siblingIndex>=idsInCol.length)){return itemId}else{return idsInCol[siblingIndex]}}};return internals.layoutWalker(findItemAboveBelow,layout)||itemId};fluid.moduleLayout.updateLayout=function(itemId,targetId,position,layout){if(!itemId||!targetId||itemId===targetId){return }var itemIndices=internals.findColumnAndItemIndices(itemId,layout);layout.columns[itemIndices.columnIndex].children.splice(itemIndices.itemIndex,1);var targetCol;if(position===fluid.position.INSIDE||position===fluid.position.USE_LAST_KNOWN){targetCol=layout.columns[internals.findColIndex(targetId,layout)].children;targetCol.splice(targetCol.length,0,itemId)}else{var relativeItemIndices=internals.findColumnAndItemIndices(targetId,layout);targetCol=layout.columns[relativeItemIndices.columnIndex].children;targetCol.splice(relativeItemIndices.itemIndex+position,0,itemId)}};fluid.moduleLayout.findTarget=function(itemId,direction,layout,perms){var targetColIndex=internals.findColumnAndItemIndices(itemId,layout).columnIndex+direction;var targetCol=layout.columns[targetColIndex];if(targetColIndex<0||targetColIndex>=internals.numColumns(layout)){return{id:itemId,position:fluid.position.BEFORE}}var idsInCol=targetCol.children;for(var i=0;(i<idsInCol.length);i++){var targetId=idsInCol[i];if(fluid.moduleLayout.canMove(itemId,targetId,fluid.position.BEFORE,layout,perms)){return{id:targetId,position:fluid.position.BEFORE}}else{if(fluid.moduleLayout.canMove(itemId,targetId,fluid.position.AFTER,layout,perms)){return{id:targetId,position:fluid.position.AFTER}}}}return{id:targetCol.id,position:fluid.position.INSIDE}};fluid.moduleLayout.targetAndPositionAbove=function(itemId,layout,perms){return internals.targetAndPos(itemId,fluid.position.BEFORE,layout,perms)};fluid.moduleLayout.targetAndPositionBelow=function(itemId,layout,perms){return internals.targetAndPos(itemId,fluid.position.AFTER,layout,perms)};fluid.moduleLayout.inferSelectors=function(layout,perms,grabHandle){perms=perms||fluid.moduleLayout.buildEmptyPerms(layout);var selectablesSelector;var movablesSelector;var dropTargets;var cols=layout.columns;for(var i=0;i<cols.length;i++){var idsInCol=cols[i].children;for(var j=0;j<idsInCol.length;j++){var itemId=idsInCol[j];var idSelector="[id="+itemId+"]";selectablesSelector=selectablesSelector?selectablesSelector+","+idSelector:idSelector;var indices=internals.findItemAndTargetIndices(itemId,itemId,fluid.position.BEFORE,layout);if(internals.canItemMove(indices.itemIndex,perms)){movablesSelector=movablesSelector?movablesSelector+","+idSelector:idSelector}if(internals.isDropTarget(indices.targetIndex,perms)){dropTargets=dropTargets?dropTargets+","+idSelector:idSelector}}var colIdSelector="[id="+cols[i].id+"]";dropTargets=dropTargets?dropTargets+","+colIdSelector:colIdSelector}var togo={movables:movablesSelector,selectables:selectablesSelector,dropTargets:dropTargets,grabHandle:grabHandle};return togo};fluid.moduleLayout.containerId=function(layout){return layout.id};fluid.moduleLayout.lastItemInCol=function(colId,layout){var colIndex=internals.findColIndex(colId,layout);var col=layout.columns[colIndex];var numChildren=col.children.length;if(numChildren>0){return col.children[numChildren-1]}return undefined};fluid.moduleLayout.buildEmptyPerms=function(layout){var numCols=internals.numColumns(layout);var numModules=internals.numModules(layout);var permsStructure=[];var numItemsInBitmap=numCols+numModules;for(var i=0;i<numModules;i++){var rowForPortlet=[];for(var j=0;j<numItemsInBitmap;j++){rowForPortlet.push(1)}permsStructure.push(rowForPortlet)}return permsStructure};fluid.moduleLayout.buildPermsForLockedModules=function(lockedModules,layout){if(lockedModules.length<=0){return fluid.moduleLayout.buildEmptyPerms(layout)}function isLocked(id){return jQuery.grep(lockedModules,function(el){return el.id===id})[0]}var permsRow=[];var lockedPermsRow=[];var moduleIds=[];for(var col=0;col<layout.columns.length;col+=1){var idsInCol=layout.columns[col].children;var prevId=null;for(var i=0;i<idsInCol.length;i+=1){var id=idsInCol[i];moduleIds.push(id);if(isLocked(id)&&(!prevId||isLocked(prevId))){permsRow.push(0)}else{permsRow.push(1)}lockedPermsRow.push(0);prevId=id}permsRow.push(1);lockedPermsRow.push(0)}var permsStructure=[];for(i=0;i<moduleIds.length;i+=1){if(isLocked(moduleIds[i])){permsStructure.push(lockedPermsRow)}else{permsStructure.push(permsRow)}}return permsStructure};fluid.moduleLayout.buildLayout=function(container,columns,portlets){var layoutStructure={};layoutStructure.id=container[0].id;layoutStructure.columns=[];columns.each(function(idx,column){var portletsInColumn=internals.findPortletsInColumn(portlets,column);layoutStructure.columns.push(internals.columnStructure(column,portletsInColumn))});return layoutStructure};var defaultWillShowKBDropWarning=function(item,dropWarning){if(dropWarning){var offset=jQuery(item).offset();dropWarning=jQuery(dropWarning);dropWarning.css("position","absolute");dropWarning.css("top",offset.top);dropWarning.css("left",offset.left)}};fluid.moduleLayoutHandler=function(container,options){var that=fluid.initView("fluid.moduleLayoutHandler",container,options);var orientation=fluid.orientation.VERTICAL;var layout=options.moduleLayout.layout;var targetPerms=options.moduleLayout.permissions||fluid.moduleLayout.buildEmptyPerms(layout);options=options||{};var orderChangedCallback=options.orderChangedCallback||function(){};if(options.orderChangedCallbackUrl){orderChangedCallback=function(item){jQuery.post(options.orderChangedCallbackUrl,JSON.stringify(layout),function(data,textStatus){targetPerms=data},"json")}}var dropWarning=fluid.utils.jById(options.dropWarningId);var willShowKBDropWarning=options.willShowKBDropWarning||defaultWillShowKBDropWarning;var getVerticalSibling=function(item,direction){var siblingId=fluid.moduleLayout.itemAboveBelow(item.id,direction,layout);return fluid.utils.jById(siblingId)[0]};var getHorizontalSibling=function(item,direction){var itemId=fluid.moduleLayout.firstItemInAdjacentColumn(item.id,direction,layout);return fluid.utils.jById(itemId)[0]};var move=function(item,relatedItem,position){if(!item||!relatedItem){return }if(position===fluid.position.BEFORE){jQuery(relatedItem).before(item)}else{if(position===fluid.position.AFTER){jQuery(relatedItem).after(item)}else{if(position===fluid.position.INSIDE){jQuery(relatedItem).append(item)}}}fluid.moduleLayout.updateLayout(item.id,relatedItem.id,position,layout);orderChangedCallback(item)};var moveHorizontally=function(item,direction){var targetInfo=fluid.moduleLayout.findTarget(item.id,direction,layout,targetPerms);var targetItem=fluid.utils.jById(targetInfo.id)[0];move(item,targetItem,targetInfo.position)};var moveVertically=function(item,targetFunc){var targetAndPos=targetFunc(item.id,layout,targetPerms);var target=fluid.utils.jById(targetAndPos.id)[0];if(targetAndPos.position===fluid.position.DISALLOWED){if(dropWarning){willShowKBDropWarning(item,dropWarning[0]);dropWarning.show()}}else{if(targetAndPos.position!==fluid.position.USE_LAST_KNOWN){move(item,target,targetAndPos.position)}}};that.getRightSibling=function(item){return getHorizontalSibling(item,fluid.direction.NEXT)};that.moveItemRight=function(item){moveHorizontally(item,fluid.direction.NEXT)};that.getLeftSibling=function(item){return getHorizontalSibling(item,fluid.direction.PREVIOUS)};that.moveItemLeft=function(item){moveHorizontally(item,fluid.direction.PREVIOUS)};that.getItemAbove=function(item){return getVerticalSibling(item,fluid.direction.PREVIOUS)};that.moveItemUp=function(item){moveVertically(item,fluid.moduleLayout.targetAndPositionAbove)};that.getItemBelow=function(item){return getVerticalSibling(item,fluid.direction.NEXT)};that.moveItemDown=function(item){moveVertically(item,fluid.moduleLayout.targetAndPositionBelow)};that.dropPosition=function(target,moving,x,y){if(fluid.moduleLayout.isColumn(target.id,layout)){var lastItemInColId=fluid.moduleLayout.lastItemInCol(target.id,layout);if(lastItemInColId===undefined){return fluid.position.INSIDE}var lastItem=fluid.utils.jById(lastItemInColId);var topOfEmptySpace=lastItem.offset().top+lastItem.height();if(y>topOfEmptySpace){return fluid.position.INSIDE}else{return fluid.position.USE_LAST_KNOWN}}var position=fluid.utils.mousePosition(target,orientation,x,y);var canDrop=fluid.moduleLayout.canMove(moving.id,target.id,position,layout,targetPerms);if(canDrop){return position}else{return fluid.position.DISALLOWED}};that.mouseMoveItem=function(moving,target,x,y,position){move(moving,target,position)};return that}})(jQuery,fluid);